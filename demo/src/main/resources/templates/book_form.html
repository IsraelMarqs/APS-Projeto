<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${book.id} != null ? 'Editar livro' : 'Adicionar livro'">Formulário de Livro</title>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; max-width:700px; margin:40px auto }
        .card { border:1px solid #ddd; padding:20px; border-radius:6px }
        .field { margin-bottom:10px }
        label { display:block; font-weight:bold }
        input[type=text], textarea, select { width:100%; padding:8px; box-sizing:border-box }
        .btn { background:#4285F4; color:white; padding:8px 12px; border-radius:4px; text-decoration:none }
    </style>
</head>
<body>
<div class="card">
    <h2 th:text="${book.id} != null ? 'Editar livro' : 'Adicionar livro'"></h2>
    <form th:action="${formAction}" method="post" th:object="${book}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="field">
            <label for="title">Título</label>
            <input type="text" id="title" th:field="*{title}" />
        </div>
        <div class="field">
            <label for="authors">Autor(es)</label>
            <input type="text" id="authors" th:field="*{authors}" placeholder="Separe múltiplos autores por vírgula" />
        </div>
        <div class="field">
            <label for="publishedYear">Ano</label>
            <input type="number" id="publishedYear" th:field="*{publishedYear}" />
        </div>
        <div class="field">
            <label for="publisher">Editora</label>
            <input type="text" id="publisher" th:field="*{publisher}" />
        </div>
        <div class="field">
            <label for="category">Categoria</label>
            <select id="category" th:field="*{category}">
                <option th:each="c : ${categories}" th:value="${c}" th:text="${c}"></option>
            </select>
        </div>
        <div class="field">
            <label for="language">Idioma</label>
            <input type="text" id="language" th:field="*{language}" />
        </div>
        <div class="field">
            <label for="location">Localização de encontro</label>
            <input type="text" id="location" th:field="*{location}" />
        </div>
        <div class="field">
            <label for="description">Descrição / Resumo</label>
            <div style="display:flex; gap:10px; align-items:start">
                <textarea id="description" th:field="*{description}" rows="4" placeholder="Escreva um resumo ou gere com IA..."></textarea>

                <button type="button" onclick="gerarDescricao()" class="btn" style="background:#8b5cf6; white-space:nowrap">
                    ✨ Gerar com IA
                </button>
            </div>
            <small id="aiStatus" style="color:#6b7280"></small>
        </div>

        <script>
            function gerarDescricao() {
                const title = document.getElementById('title').value;
                const authors = document.getElementById('authors').value;
                const status = document.getElementById('aiStatus');
                const descField = document.getElementById('description');

                // Precisamos do token CSRF do Spring Security
                const csrfToken = document.querySelector('input[name="_csrf"]').value;

                if(!title) {
                    alert("Preencha o título do livro primeiro!");
                    return;
                }

                status.innerText = "Pensando...";

                fetch('/books/generate-description', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({ title: title, authors: authors })
                })
                    .then(response => response.json())
                    .then(data => {
                        descField.value = data.description;
                        status.innerText = "";
                    })
                    .catch(err => {
                        console.error(err);
                        status.innerText = "Erro ao conectar com a IA.";
                    });
            }
        </script>
        <div class="field">
            <label for="contactNumber">Número de contato (destaque)</label>
            <input type="text" id="contactNumber" th:field="*{contactNumber}" />
        </div>
        <div>
            <button type="submit" class="btn">Salvar</button>
            <a th:href="@{/}" style="margin-left:8px">Cancelar</a>
        </div>
    </form>
</div>
</body>
</html>
