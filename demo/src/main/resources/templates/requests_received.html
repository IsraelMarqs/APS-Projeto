<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pedidos Recebidos - Biblioconnect</title>
    <style>
        body { font-family: Inter, Arial, Helvetica, sans-serif; max-width:900px; margin:40px auto; background:#f6f8fb }
        .card { border:1px solid #e6e9ee; padding:18px; border-radius:10px; background:white; box-shadow:0 8px 30px rgba(2,6,23,0.04) }
        .request-item { border-radius:10px; padding:12px; margin-bottom:10px; background:linear-gradient(180deg,#fff,#fbfdff); border:1px solid #eef2ff }
        .muted { color:#6b7280 }

        .status { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:600; font-size:0.85em }
        .PENDING { background:#fef3c7; color:#92400e }
        .ACCEPTED { background:#dcfce7; color:#166534 }
        .DECLINED { background:#fee2e2; color:#991b1b }
        .RETURNED { background:#e0e7ff; color:#3730a3 } /* Nova cor Roxo/Azul */

        .btn { background:#4f46e5; color:white; padding:8px 12px; border-radius:8px; text-decoration:none; border:none; cursor:pointer }
        .danger { background:#ef4444 }
        .secondary { background:#e6e6f9; color:#2b2b78 }
        .secondary:hover { background:#dbeafe }

        /* Botão específico para devolver e repostar */
        .repost { background:#059669; }

        .small { font-size:0.9em; color:#374151 }
        form.inline { display:inline-block; margin-left:8px; margin-top:5px }
    </style>
</head>
<body>
<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
        <h2 style="margin:0">Pedidos recebidos</h2>
        <a th:href="@{/}" class="btn secondary">Voltar</a>
    </div>

    <div th:if="${#lists.isEmpty(requests)}" class="muted">Você ainda não recebeu solicitações de empréstimo.</div>

    <div th:each="r : ${requests}" class="request-item">
        <div><strong th:text="${r.book.title}"></strong> <span class="muted">— <span th:text="${r.book.authors}"></span></span></div>
        <div class="small">Solicitante: <strong th:text="${r.requester.name}"></strong> (<span th:text="${r.requester.email}"></span>)</div>
        <div style="margin-top:8px">
            <span th:text="${#dates.format(r.createdAt,'dd/MM/yyyy HH:mm')}"></span>
            <span th:classappend="' status ' + ${r.status}" th:text="${r.status}"></span>
        </div>
        <div style="margin-top:8px" class="small" th:if="${r.message}">Mensagem: <span th:text="${r.message}"></span></div>

        <div style="margin-top:10px">
            <a th:href="@{/books/{id}(id=${r.book.id})}" class="btn secondary" style="font-size:0.9em">Ver livro</a>

            <th:block th:if="${r.status.name() == 'PENDING'}">
                <form th:action="@{/requests/{id}/respond(id=${r.id})}" method="post" class="inline">
                    <input type="hidden" name="action" value="accept" />
                    <button type="submit" class="btn">Aceitar</button>
                </form>
                <form th:action="@{/requests/{id}/respond(id=${r.id})}" method="post" class="inline">
                    <input type="hidden" name="action" value="decline" />
                    <button type="submit" class="btn danger">Recusar</button>
                </form>
            </th:block>

            <th:block th:if="${r.status.name() == 'ACCEPTED'}">
                <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #e5e7eb">
                    <span class="small muted">O livro foi devolvido?</span><br>

                    <form th:action="@{/requests/{id}/respond(id=${r.id})}" method="post" class="inline" style="margin-left:0">
                        <input type="hidden" name="action" value="return_archive" />
                        <button type="submit" class="btn secondary" title="Marca como devolvido, mas não mostra na Home">
                            Recebi (Arquivar)
                        </button>
                    </form>

                    <form th:action="@{/requests/{id}/respond(id=${r.id})}" method="post" class="inline">
                        <input type="hidden" name="action" value="return_repost" />
                        <button type="submit" class="btn repost" title="Marca como devolvido e mostra na Home para outros">
                            Recebi (Repostar)
                        </button>
                    </form>
                </div>
            </th:block>

        </div>
    </div>
</div>
</body>
</html>